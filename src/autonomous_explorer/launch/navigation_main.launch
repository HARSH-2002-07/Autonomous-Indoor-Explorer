<launch>
  <!-- Arguments -->
  <arg name="map_file" default="$(find autonomous_explorer)/maps/mymap.yaml"/>
  <arg name="rviz_config" default="$(find autonomous_explorer)/rviz/nav_config.rviz"/>

  <!-- Map Server -->
  <node name="map_server" pkg="map_server" type="map_server" args="$(arg map_file)" output="screen"/>

  <!-- AMCL -->
  <node name="amcl" pkg="amcl" type="amcl" output="screen">
    <rosparam file="$(find autonomous_explorer)/config/amcl.yaml" command="load"/>
    <remap from="scan" to="scan"/>
    <remap from="map" to="map"/>
  </node>

  <!-- Add this to your launch file after AMCL node -->
<node name="initial_pose_pub" pkg="rostopic" type="rostopic" 
      args="pub /initialpose geometry_msgs/PoseWithCovarianceStamped 
      '{header: {frame_id: map}, 
        pose: {pose: {position: {x: -1.0, y: 1.0, z: 0.0}, 
                     orientation: {x: 0.0, y: 0.0, z: 0.0, w: 1.0}},
               covariance: [0.25, 0.0, 0.0, 0.0, 0.0, 0.0,
                           0.0, 0.25, 0.0, 0.0, 0.0, 0.0,
                           0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                           0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                           0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
                           0.0, 0.0, 0.0, 0.0, 0.0, 0.06853891945200942]}}' 
      --once"/>

  <!-- Move Base with explicit parameters -->
  <node name="move_base" pkg="move_base" type="move_base" output="screen">
    <!-- Load common costmap parameters for both global and local -->
    <rosparam file="$(find autonomous_explorer)/config/costmap_common_params.yaml" command="load" ns="global_costmap"/>
    <rosparam file="$(find autonomous_explorer)/config/costmap_common_params.yaml" command="load" ns="local_costmap"/>
    
    <!-- Load local costmap specific parameters -->
    <rosparam file="$(find autonomous_explorer)/config/local_costmap_params.yaml" command="load"/>
    
    <!-- Load base local planner parameters -->
    <rosparam file="$(find autonomous_explorer)/config/base_local_planner_params.yaml" command="load"/>
    
    <!-- EXPLICIT Global Costmap Parameters - Set directly here -->
    <param name="global_costmap/global_frame" value="map"/>
    <param name="global_costmap/robot_base_frame" value="base_link"/>
    <param name="global_costmap/update_frequency" value="5.0"/>
    <param name="global_costmap/publish_frequency" value="2.0"/>
    <param name="global_costmap/static_map" value="true"/>
    <param name="global_costmap/rolling_window" value="false"/>
    <param name="global_costmap/width" value="13.8"/>
    <param name="global_costmap/height" value="11.6"/>
    <param name="global_costmap/resolution" value="0.05"/>
    <param name="global_costmap/origin_x" value="-5.760373"/>
    <param name="global_costmap/origin_y" value="-5.775"/>
    
    <!-- Remap to use map_server's map -->
    <remap from="map" to="map"/>
  </node>

  <!-- RViz -->
  <node name="rviz" pkg="rviz" type="rviz" args="-d $(arg rviz_config)" required="true"/>
</launch>